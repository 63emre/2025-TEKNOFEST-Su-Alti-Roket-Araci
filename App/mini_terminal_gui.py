#!/usr/bin/env python3
"""
Mini Terminal GUI - KÃ¼Ã§Ã¼k Ekranlar Ä°Ã§in
Sadece temel kontrol ve debug
"""

import sys
import time
import threading
from datetime import datetime

# Pi5 + PiOS curses desteÄŸi
try:
    import curses
    print("âœ… Terminal UI hazÄ±r (Pi5 + PiOS)")
except ImportError as e:
    print(f"âŒ Terminal UI hatasÄ±: {e}")
    sys.exit(1)

# Local imports
try:
    from mavlink_handler import MAVLinkHandler
    print("âœ… MAVLinkHandler import OK")
except ImportError as e:
    print(f"âŒ MAVLinkHandler import error: {e}")
    sys.exit(1)

class MiniTerminalGUI:
    def __init__(self):
        """Mini GUI baÅŸlatÄ±cÄ±"""
        self.mavlink = None
        self.connected = False
        self.armed = False
        self.running = True
        
        # IMU data
        self.imu_data = {'roll': 0, 'pitch': 0, 'yaw': 0}
        
        # Debug log
        self.debug_log = []
        
    def connect_mavlink(self):
        """MAVLink baÄŸlantÄ±sÄ± kur"""
        try:
            self.debug_log.append("ðŸ“¡ MAVLink baÄŸlantÄ±sÄ± kuruluyor...")
            self.mavlink = MAVLinkHandler()
            
            if self.mavlink.connect():
                self.connected = True
                self.debug_log.append("âœ… MAVLink baÄŸlandÄ±!")
                
                # ARM durumu
                self.mavlink.check_system_status()
                self.armed = self.mavlink.armed
                
                return True
            else:
                self.debug_log.append("âŒ MAVLink baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z!")
                return False
                
        except Exception as e:
            self.debug_log.append(f"âŒ MAVLink hatasÄ±: {e}")
            return False
    
    def update_imu(self):
        """IMU verilerini gÃ¼ncelle"""
        if not self.mavlink or not self.connected:
            return
        
        try:
            imu = self.mavlink.get_imu_data()
            if imu and len(imu) >= 6:
                # Basit orientation hesaplama
                import math
                accel_x, accel_y, accel_z = imu[0], imu[1], imu[2]
                
                if abs(accel_z) > 0.001:
                    roll = math.degrees(math.atan2(accel_y, accel_z))
                    pitch = math.degrees(math.atan2(-accel_x, math.sqrt(accel_y*accel_y + accel_z*accel_z)))
                    
                    self.imu_data['roll'] = roll
                    self.imu_data['pitch'] = pitch
                    # YAW ayrÄ± hesaplanÄ±r, ÅŸimdilik 0
                    
        except:
            pass
    
    def draw_screen(self, stdscr):
        """EkranÄ± Ã§iz - KOMPAKT"""
        height, width = stdscr.getmaxyx()
        
        # En az 80x20 gerekli
        if width < 80 or height < 20:
            stdscr.addstr(0, 0, f"âŒ Terminal Ã§ok kÃ¼Ã§Ã¼k: {width}x{height}")
            stdscr.addstr(1, 0, "ðŸ’¡ En az 80x20 gerekli")
            stdscr.refresh()
            return
        
        stdscr.clear()
        
        # BaÅŸlÄ±k
        title = "ðŸš€ TEKNOFEST ROV - Mini GUI"
        stdscr.addstr(0, (width - len(title)) // 2, title, curses.A_BOLD)
        
        # Durum satÄ±rÄ±
        conn_status = "âœ… BAÄžLI" if self.connected else "âŒ BAÄžLI DEÄžÄ°L"
        arm_status = "ðŸ”´ ARMED" if self.armed else "ðŸŸ¢ DISARMED"
        stdscr.addstr(1, 2, f"TCP: {conn_status}")
        stdscr.addstr(1, 20, f"Durum: {arm_status}")
        
        # IMU verileri
        stdscr.addstr(3, 2, "ðŸ“Š IMU DATA:", curses.A_BOLD)
        stdscr.addstr(4, 4, f"Roll:  {self.imu_data['roll']:+6.1f}Â°")
        stdscr.addstr(5, 4, f"Pitch: {self.imu_data['pitch']:+6.1f}Â°")
        stdscr.addstr(6, 4, f"Yaw:   {self.imu_data['yaw']:+6.1f}Â°")
        
        # Kontroller
        stdscr.addstr(8, 2, "âŒ¨ï¸ KONTROL:", curses.A_BOLD)
        stdscr.addstr(9, 4, "Space: ARM/DISARM")
        stdscr.addstr(10, 4, "R: Yeniden BaÄŸlan")
        stdscr.addstr(11, 4, "Q: Ã‡Ä±kÄ±ÅŸ")
        
        # Debug log (son 5 mesaj)
        stdscr.addstr(13, 2, "ðŸ“ DEBUG:", curses.A_BOLD)
        recent_logs = self.debug_log[-5:] if len(self.debug_log) > 5 else self.debug_log
        
        for i, log in enumerate(recent_logs):
            if 14 + i < height - 1:
                # Log mesajÄ±nÄ± ekrana sÄ±ÄŸacak ÅŸekilde kÄ±salt
                display_log = log[:width - 6]
                stdscr.addstr(14 + i, 4, display_log)
        
        stdscr.refresh()
    
    def handle_input(self, stdscr):
        """Klavye giriÅŸi"""
        key = stdscr.getch()
        
        if key == ord('q') or key == ord('Q'):
            self.running = False
        elif key == ord(' '):  # Space - ARM/DISARM
            self.toggle_arm()
        elif key == ord('r') or key == ord('R'):
            self.reconnect()
    
    def toggle_arm(self):
        """ARM/DISARM toggle"""
        if not self.connected:
            self.debug_log.append("âš ï¸ BaÄŸlantÄ± yok - ARM edilemez")
            return
        
        try:
            if self.armed:
                self.mavlink.disarm_system()
                self.armed = False
                self.debug_log.append("ðŸŸ¢ DISARM edildi")
            else:
                if self.mavlink.arm_system():
                    self.armed = True
                    self.debug_log.append("ðŸ”´ ARM edildi")
                else:
                    self.debug_log.append("âŒ ARM baÅŸarÄ±sÄ±z")
        except Exception as e:
            self.debug_log.append(f"âŒ ARM hatasÄ±: {e}")
    
    def reconnect(self):
        """Yeniden baÄŸlan"""
        self.debug_log.append("ðŸ”„ Yeniden baÄŸlanÄ±lÄ±yor...")
        self.connected = False
        self.connect_mavlink()
    
    def run(self, stdscr):
        """Ana dÃ¶ngÃ¼"""
        # Curses setup
        curses.curs_set(0)
        curses.noecho()
        stdscr.keypad(True)
        stdscr.nodelay(True)
        stdscr.timeout(100)  # 10Hz update
        
        # Ä°lk baÄŸlantÄ±
        self.connect_mavlink()
        
        # Ana dÃ¶ngÃ¼
        while self.running:
            try:
                # IMU gÃ¼ncelle
                self.update_imu()
                
                # EkranÄ± Ã§iz
                self.draw_screen(stdscr)
                
                # Klavye giriÅŸi
                self.handle_input(stdscr)
                
                time.sleep(0.1)  # 10Hz
                
            except KeyboardInterrupt:
                self.running = False
            except Exception as e:
                self.debug_log.append(f"âŒ Ana dÃ¶ngÃ¼ hatasÄ±: {e}")
    
    def cleanup(self):
        """Temizlik"""
        if self.mavlink and self.connected:
            try:
                self.mavlink.disconnect()
            except:
                pass

def main():
    """Ana fonksiyon"""
    print("ðŸš€ Mini Terminal GUI baÅŸlatÄ±lÄ±yor...")
    
    gui = MiniTerminalGUI()
    
    try:
        curses.wrapper(gui.run)
    except Exception as e:
        print(f"âŒ GUI hatasÄ±: {e}")
    finally:
        gui.cleanup()

if __name__ == "__main__":
    main() 