<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEKNOFEST 2025 - Su Altı ROV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 1fr auto;
            height: calc(100vh - 80px);
            gap: 10px;
            padding: 10px;
        }
        
        .panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            overflow-y: auto;
        }
        
        .control-panel {
            grid-column: 1;
        }
        
        .main-panel {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .status-panel {
            grid-column: 3;
        }
        
        .bottom-panel {
            grid-column: 1 / -1;
            max-height: 200px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section h3 {
            margin-bottom: 15px;
            color: #64b5f6;
            border-bottom: 2px solid #64b5f6;
            padding-bottom: 5px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; }
        .status-disconnected { background: #f44336; }
        .status-armed { background: #ff9800; }
        
        .btn {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px 0;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #ff5722);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .input-group input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex: 1;
        }
        
        .telemetry-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .telemetry-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .telemetry-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .chart-container {
            height: 300px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .vibration-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .vibration-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
            border-radius: 10px;
        }
        
        .vibration-low { background: #4caf50; }
        .vibration-medium { background: #ff9800; }
        .vibration-high { background: #f44336; }
        
        .log-area {
            background: rgba(0,0,0,0.5);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 150px;
            overflow-y: auto;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            margin: 5px 0;
        }
        
        select option {
            background: #1e3c72;
            color: white;
        }
        
        .keyboard-help {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 15px;
        }
        
        .keyboard-help h4 {
            margin-bottom: 8px;
            color: #64b5f6;
        }
        
        .key-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .emergency-button {
            background: linear-gradient(45deg, #d32f2f, #f44336);
            font-size: 18px;
            padding: 15px;
            border: 3px solid #ffcdd2;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }
            
            .control-panel, .main-panel, .status-panel, .bottom-panel {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 TEKNOFEST 2025 - Su Altı ROV Kontrol Sistemi</h1>
    </div>
    
    <div class="container">
        <!-- Sol Panel - Kontrol -->
        <div class="panel control-panel">
            <div class="section">
                <h3>Sistem Kontrolü</h3>
                <div>
                    <span class="status-indicator" id="connection-status"></span>
                    <span id="connection-text">Bağlantı Yok</span>
                </div>
                <button class="btn" id="connect-btn" onclick="toggleConnection()">MAVLink Bağlan</button>
                <button class="btn" id="arm-btn" onclick="toggleArm()" disabled>ARM / DISARM</button>
            </div>
            
            <div class="section">
                <h3>Kontrol Modu</h3>
                <select id="control-mode" onchange="setControlMode()">
                    <option value="raw">RAW PWM (Titreşimsiz)</option>
                    <option value="pid">PID Kontrolü (Filtreli)</option>
                </select>
            </div>
            
            <div class="section">
                <h3>Navigation Modu</h3>
                <select id="navigation-mode" onchange="setNavigationMode()">
                    <option value="imu_only">IMU Dead Reckoning</option>
                    <option value="gps_only">GPS Navigation</option>
                    <option value="hybrid">Hibrit (GPS + IMU)</option>
                </select>
            </div>
            
            <div class="section">
                <h3>Hareket Komutları</h3>
                <div class="input-group">
                    <input type="number" id="forward-input" placeholder="Metre" step="0.1" value="5.0">
                    <button class="btn" onclick="executeMovement('FORWARD')">İleri Git (T)</button>
                </div>
                <div class="input-group">
                    <input type="number" id="yaw-input" placeholder="Derece" step="1" value="90">
                    <button class="btn" onclick="executeMovement('YAW_ROTATION')">Yaw Dön (Y)</button>
                </div>
                <div class="input-group">
                    <input type="number" id="ascend-input" placeholder="Metre" step="0.1" value="2.0">
                    <button class="btn" onclick="executeMovement('ASCEND')">Yukarı Çık (U)</button>
                </div>
                <div class="input-group">
                    <input type="number" id="left-input" placeholder="Metre" step="0.1" value="3.0">
                    <button class="btn" onclick="executeMovement('STRAFE_LEFT')">Sol Git (G)</button>
                </div>
                <div class="input-group">
                    <input type="number" id="right-input" placeholder="Metre" step="0.1" value="3.0">
                    <button class="btn" onclick="executeMovement('STRAFE_RIGHT')">Sağ Git (H)</button>
                </div>
            </div>
            
            <div class="section">
                <h3>Acil Durum</h3>
                <button class="btn emergency-button" onclick="emergencyStop()">🚨 ACİL DURUM</button>
            </div>
            
            <div class="section">
                <div class="keyboard-help">
                    <h4>⌨️ Klavye Kontrolleri</h4>
                    <div class="key-row"><span>W,A,S,D</span><span>Servo Kontrol</span></div>
                    <div class="key-row"><span>Q,E</span><span>Yaw Dönme</span></div>
                    <div class="key-row"><span>PgUp/PgDn</span><span>Derinlik</span></div>
                    <div class="key-row"><span>Space</span><span>Acil Durum</span></div>
                    <div class="key-row"><span>Esc</span><span>Yüzeye Çık</span></div>
                </div>
            </div>
        </div>
        
        <!-- Orta Panel - Telemetry -->
        <div class="panel main-panel">
            <div class="telemetry-grid">
                <div class="telemetry-item">
                    <div class="telemetry-label">Roll</div>
                    <div class="telemetry-value" id="roll-value">0.0°</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Pitch</div>
                    <div class="telemetry-value" id="pitch-value">0.0°</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">Yaw</div>
                    <div class="telemetry-value" id="yaw-value">0.0°</div>
                </div>
                <div class="telemetry-item">
                    <div class="telemetry-label">GPS Uydu</div>
                    <div class="telemetry-value" id="gps-sats">0</div>
                </div>
            </div>
            
            <div class="chart-container" id="imu-chart"></div>
        </div>
        
        <!-- Sağ Panel - Durum -->
        <div class="panel status-panel">
            <div class="section">
                <h3>Sistem Durumu</h3>
                <div><strong>Voltaj:</strong> <span id="voltage">0.0V</span></div>
                <div><strong>Akım:</strong> <span id="current">0.0A</span></div>
                <div><strong>Güç:</strong> <span id="power">0.0W</span></div>
            </div>
            
            <div class="section">
                <h3>GPS Konumu</h3>
                <div><strong>Enlem:</strong> <span id="latitude">0.000000</span></div>
                <div><strong>Boylam:</strong> <span id="longitude">0.000000</span></div>
                <div><strong>Uydu Sayısı:</strong> <span id="satellites">0</span></div>
            </div>
            
            <div class="section">
                <h3>Titreşim Seviyesi</h3>
                <div class="vibration-bar">
                    <div class="vibration-fill" id="vibration-bar"></div>
                </div>
                <div><strong>Seviye:</strong> <span id="vibration-level">0</span></div>
                <div><strong>Kategori:</strong> <span id="vibration-category">Low</span></div>
            </div>
        </div>
        
        <!-- Alt Panel - Loglar -->
        <div class="panel bottom-panel">
            <div class="section">
                <h3>Sistem Logları</h3>
                <div class="log-area" id="log-area">
                    <div>[INFO] TEKNOFEST ROV Web GUI başlatıldı</div>
                    <div>[INFO] Sistem hazır, bağlantı bekleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        
        // System status
        let systemStatus = {
            connected: false,
            armed: false,
            control_mode: 'raw',
            navigation_mode: 'imu_only'
        };
        
        // Charts
        let imuChart = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupKeyboardControls();
            loadSystemStatus();
        });
        
        // WebSocket events
        socket.on('connect', function() {
            addLog('[INFO] Web bağlantısı kuruldu');
        });
        
        socket.on('system_status', function(data) {
            updateSystemStatus(data);
        });
        
        socket.on('telemetry_update', function(data) {
            updateTelemetry(data);
        });
        
        // System control functions
        async function toggleConnection() {
            try {
                const response = await fetch('/api/connect', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    systemStatus.connected = data.connected;
                    updateConnectionUI();
                    addLog(`[INFO] Bağlantı ${data.connected ? 'kuruldu' : 'kapatıldı'}`);
                } else {
                    addLog('[ERROR] Bağlantı hatası');
                }
            } catch (error) {
                addLog('[ERROR] API hatası: ' + error.message);
            }
        }
        
        async function toggleArm() {
            try {
                const response = await fetch('/api/arm', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    systemStatus.armed = data.armed;
                    updateArmUI();
                    addLog(`[INFO] Sistem ${data.armed ? 'ARM' : 'DISARM'} edildi`);
                } else {
                    addLog('[ERROR] ARM/DISARM hatası');
                }
            } catch (error) {
                addLog('[ERROR] API hatası: ' + error.message);
            }
        }
        
        async function setControlMode() {
            const mode = document.getElementById('control-mode').value;
            try {
                const response = await fetch('/api/control_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                const data = await response.json();
                
                if (data.success) {
                    systemStatus.control_mode = mode;
                    addLog(`[INFO] Kontrol modu: ${mode}`);
                }
            } catch (error) {
                addLog('[ERROR] Kontrol modu hatası: ' + error.message);
            }
        }
        
        async function setNavigationMode() {
            const mode = document.getElementById('navigation-mode').value;
            try {
                const response = await fetch('/api/navigation_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                const data = await response.json();
                
                if (data.success) {
                    systemStatus.navigation_mode = mode;
                    addLog(`[INFO] Navigation modu: ${mode}`);
                }
            } catch (error) {
                addLog('[ERROR] Navigation modu hatası: ' + error.message);
            }
        }
        
        async function executeMovement(command) {
            let parameter;
            switch(command) {
                case 'FORWARD':
                    parameter = parseFloat(document.getElementById('forward-input').value);
                    break;
                case 'YAW_ROTATION':
                    parameter = parseFloat(document.getElementById('yaw-input').value);
                    break;
                case 'ASCEND':
                    parameter = parseFloat(document.getElementById('ascend-input').value);
                    break;
                case 'STRAFE_LEFT':
                    parameter = parseFloat(document.getElementById('left-input').value);
                    break;
                case 'STRAFE_RIGHT':
                    parameter = parseFloat(document.getElementById('right-input').value);
                    break;
            }
            
            try {
                const response = await fetch('/api/movement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command, parameter: parameter })
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog(`[INFO] Hareket komutu: ${command} ${parameter}`);
                } else {
                    addLog(`[ERROR] Hareket komutu başarısız: ${command}`);
                }
            } catch (error) {
                addLog('[ERROR] Hareket komutu hatası: ' + error.message);
            }
        }
        
        async function emergencyStop() {
            try {
                const response = await fetch('/api/emergency', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog('[WARNING] 🚨 ACİL DURUM BUTONU BASILDI!');
                }
            } catch (error) {
                addLog('[ERROR] Acil durum hatası: ' + error.message);
            }
        }
        
        // UI update functions
        function updateConnectionUI() {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            const connectBtn = document.getElementById('connect-btn');
            const armBtn = document.getElementById('arm-btn');
            
            if (systemStatus.connected) {
                statusEl.className = 'status-indicator status-connected';
                textEl.textContent = 'Bağlı';
                connectBtn.textContent = 'Bağlantıyı Kes';
                armBtn.disabled = false;
            } else {
                statusEl.className = 'status-indicator status-disconnected';
                textEl.textContent = 'Bağlantı Yok';
                connectBtn.textContent = 'MAVLink Bağlan';
                armBtn.disabled = true;
                systemStatus.armed = false;
                updateArmUI();
            }
        }
        
        function updateArmUI() {
            const armBtn = document.getElementById('arm-btn');
            if (systemStatus.armed) {
                armBtn.textContent = 'DISARM';
                armBtn.className = 'btn btn-danger';
            } else {
                armBtn.textContent = 'ARM';
                armBtn.className = 'btn btn-success';
            }
        }
        
        function updateTelemetry(data) {
            // IMU data
            if (data.imu) {
                document.getElementById('roll-value').textContent = data.imu.roll.toFixed(1) + '°';
                document.getElementById('pitch-value').textContent = data.imu.pitch.toFixed(1) + '°';
                document.getElementById('yaw-value').textContent = data.imu.yaw.toFixed(1) + '°';
                
                // Update IMU chart
                updateIMUChart(data.imu);
            }
            
            // GPS data
            if (data.gps) {
                document.getElementById('latitude').textContent = data.gps.latitude.toFixed(6);
                document.getElementById('longitude').textContent = data.gps.longitude.toFixed(6);
                document.getElementById('satellites').textContent = data.gps.satellites;
                document.getElementById('gps-sats').textContent = data.gps.satellites;
            }
            
            // System data
            if (data.system) {
                document.getElementById('voltage').textContent = data.system.voltage.toFixed(1) + 'V';
                document.getElementById('current').textContent = data.system.current.toFixed(1) + 'A';
                document.getElementById('power').textContent = (data.system.voltage * data.system.current).toFixed(1) + 'W';
            }
            
            // Vibration data
            if (data.vibration) {
                updateVibrationDisplay(data.vibration.level, data.vibration.category);
            }
        }
        
        function updateVibrationDisplay(level, category) {
            const bar = document.getElementById('vibration-bar');
            const levelEl = document.getElementById('vibration-level');
            const categoryEl = document.getElementById('vibration-category');
            
            levelEl.textContent = level;
            categoryEl.textContent = category;
            
            bar.style.width = level + '%';
            
            if (level < 30) {
                bar.className = 'vibration-fill vibration-low';
            } else if (level < 70) {
                bar.className = 'vibration-fill vibration-medium';
            } else {
                bar.className = 'vibration-fill vibration-high';
            }
        }
        
        function updateSystemStatus(status) {
            systemStatus = status;
            updateConnectionUI();
            updateArmUI();
            
            document.getElementById('control-mode').value = status.control_mode;
            document.getElementById('navigation-mode').value = status.navigation_mode;
        }
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateSystemStatus(data);
            } catch (error) {
                addLog('[ERROR] Durum yükleme hatası: ' + error.message);
            }
        }
        
        function initializeCharts() {
            // IMU Chart
            const imuData = [
                { x: [], y: [], name: 'Roll', type: 'scatter', mode: 'lines' },
                { x: [], y: [], name: 'Pitch', type: 'scatter', mode: 'lines' },
                { x: [], y: [], name: 'Yaw', type: 'scatter', mode: 'lines' }
            ];
            
            const layout = {
                title: 'IMU Verileri (Real-time)',
                xaxis: { title: 'Zaman' },
                yaxis: { title: 'Derece' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0.3)',
                font: { color: 'white' }
            };
            
            Plotly.newPlot('imu-chart', imuData, layout);
            imuChart = imuData;
        }
        
        function updateIMUChart(imuData) {
            if (!imuChart) return;
            
            const time = new Date();
            
            // Add new data points
            imuChart[0].x.push(time);
            imuChart[0].y.push(imuData.roll);
            
            imuChart[1].x.push(time);
            imuChart[1].y.push(imuData.pitch);
            
            imuChart[2].x.push(time);
            imuChart[2].y.push(imuData.yaw);
            
            // Keep only last 100 points
            if (imuChart[0].x.length > 100) {
                imuChart[0].x.shift();
                imuChart[0].y.shift();
                imuChart[1].x.shift();
                imuChart[1].y.shift();
                imuChart[2].x.shift();
                imuChart[2].y.shift();
            }
            
            // Update chart
            Plotly.redraw('imu-chart');
        }
        
        function setupKeyboardControls() {
            document.addEventListener('keydown', function(event) {
                if (!systemStatus.armed) return;
                
                const key = event.key.toLowerCase();
                
                // Real-time controls
                switch(key) {
                    case 'w':
                        socket.emit('control_command', { command: 'pitch_up', value: 1 });
                        break;
                    case 's':
                        socket.emit('control_command', { command: 'pitch_down', value: 1 });
                        break;
                    case 'a':
                        socket.emit('control_command', { command: 'roll_left', value: 1 });
                        break;
                    case 'd':
                        socket.emit('control_command', { command: 'roll_right', value: 1 });
                        break;
                    case 'q':
                        socket.emit('control_command', { command: 'yaw_left', value: 1 });
                        break;
                    case 'e':
                        socket.emit('control_command', { command: 'yaw_right', value: 1 });
                        break;
                    case ' ':
                        emergencyStop();
                        event.preventDefault();
                        break;
                    case 'escape':
                        addLog('[INFO] Yüzeye çıkış komutu');
                        break;
                }
            });
            
            document.addEventListener('keyup', function(event) {
                if (!systemStatus.armed) return;
                
                const key = event.key.toLowerCase();
                
                // Stop real-time controls
                if (['w', 's', 'a', 'd', 'q', 'e'].includes(key)) {
                    socket.emit('control_command', { command: 'stop', value: 0 });
                }
            });
        }
        
        function addLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // Keep only last 100 log entries
            while (logArea.children.length > 100) {
                logArea.removeChild(logArea.firstChild);
            }
        }
    </script>
</body>
</html> 